{% extends "home/base.html" %}
{% load staticfiles %}
{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
{% endblock %}
{% block content %}
  <style>
  .ui-menu { width: 200px; }
  .ui-widget-header { padding: 0.2em; }
  .info_text {padding: 0.2em;}
  .tooltip{}
  .large.tooltip-inner {
      max-width: 450px;
      width: 450px;
      text-align:left;
    }
  .medium.tooltip-inner {
      max-width: 300px;
      width: 300px;
    }

  </style>

<div class="modal bd-example-modal-lg" id="myModal"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Modal title</h4>
      </div>
      <div class="modal-body" id="ModalBody">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<h2> Construct Design Tool  </h2>

<p> This is a tool to help aid crystallographers design crystal constructs.<a href=#  onclick='modifications_overview();showModal("Introduction",tables["help"]);'> Press here for an introduction.</a> <button id=toolvideo mp4="http://files.gpcrdb.org/video/constructtool1.mp4" type="button" class="videoLink btn btn-xs btn-default">
                          <span class="glyphicon glyphicon-film"></span>
                        </button></p>

<p>
Target: {{target.entry_name}} | 
Class: {{class}}
</p>

<div id="dialog" title="Reset">
  <p>You sure you want to reset this construct?</p>
</div>

{% if active_xtals  %}
  State: <div class="btn-group" data-toggle="buttons">
    <label class="btn btn-default active">
      <input type="radio" name="state" value="inactive" checked=""> Inactive
    </label>
    <label class="btn btn-default">
      <input type="radio" name="state" value="active"> Active
    </label>
  </div>
{% else %}
  <input type="radio" class="hidden" name="state" value="inactive" checked="">
{% endif %}

Fusion Site: <div class="btn-group" data-toggle="buttons">
  <label class="btn btn-default">
    <input type="radio" name="fusionpos" value="nterm"> N-term
  </label>

    {% if class == 'A' or class == 'F' %}
  <label class="btn btn-default active">
    <input type="radio" name="fusionpos" value="icl3" checked=""> ICL3
  </label>
  {% elif class == 'B' or class == 'C' %}
  <label class="btn btn-default active">
    <input type="radio" name="fusionpos" value="icl3" checked=""> ICL2
  </label>
  {% endif %}

  <label class="btn btn-default">
    <input type="radio" name="fusionpos" value="None"> None
  </label>
</div>
<button class="btn btn-warning" onclick='$( "#dialog" ).dialog( "open" )''>Reset</button>
<button class="btn btn-info" onclick='exportCSVsuggestions();'>Export all suggestions</button>

<form action="/common/importexcel" style="display: inline;" method="post" id="file-upload-form" enctype="multipart/form-data">
    <label class="btn btn-primary btn-file">
      Upload excelfile <input  id="id_file_source" name="file_source" type="file" style="display: none;">
    </label>
</form>

<br>
<br>
<span id='load'>
<span id=loadstatus>Please wait for the dataset to load</span>
<span id='method_options' style='display: none;'>
<div class="row">
  <div class="col-sm-2">
  Deletions:
  </div>
  <div class="col-sm-8">
    <button type="button" id="nterm_button" class="btn btn-primary" onclick='showModal("N-term",tables["nterm"],"#nterm_sug");'>
      N-term
    </button>

      {% if class == 'A'  or class == 'F' %}
        <button type="button" id="icl3_start_button" class="btn btn-primary" onclick='showModal("ICL3 (Start)",tables["icl3_start"],"#icl3_sug_start");'>
        ICL3
        </button>
      {% elif class == 'B' or class == 'C' %}
        <button type="button" id="icl2_start_button" class="btn btn-primary" onclick='showModal("ICL2 (Start)",tables["icl2_start"],"#icl2_sug_start");'>
        ICL2
        </button>
      {% endif %}

    <button type="button" id="cterm_button" class="btn btn-primary" onclick='showModal("C-term",tables["cterm"],"#cterm_sug");'>
      C-term
    </button>
  </div>
</div>
<div class="row">
  <div class="col-sm-2">
  Mutations:
  </div>
  <div class="col-sm-8">
    <button type="button" id="mutations_button" class="btn btn-primary" onclick='build_mutations();showModal("Thermostabilisation",tables["mutations"],"#mut_sug");'>
      Thermostabilisation
    </button>
    <button type="button" id="removals_button" class="btn btn-primary" onclick='build_site_removals();showModal("Site removals",tables["site_removals"],"#site_sug");'>
      Site Removal
    </button>
  </div>
</div>
<div class="row">
  <div class="col-sm-2">
  Other:
  </div>
  <div class="col-sm-8">
    <button type="button" id="mutations_button" class="btn btn-primary" onclick='showModal("Custom",tables["custom"]);'>
      Custom modification
    </button>
    <button type="button" id="removals_button" class="btn btn-primary" onclick='modifications_overview();showModal("Overview",tables["overview"]);'>
      Current modifications
    </button>

    <button class="btn btn-info" onclick='exportToExcel();'>Export modifications</button>

  </div>
</div>
</span>
<div class="row">
  <div class="col-sm-12">
  {{ target.get_snake_plot_no_buttons }}
  </div>
</div>
<div class="row">
  <div class="col-sm-12">
    <div id="overview">
    </div>
  </div>
</div>
<iframe id="my_iframe" style="display:none;"></iframe>
{% endblock %}

{% block addon_js %}
    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
    <script src="{% static 'home/js/saveSvgAsPng.js' %}"></script>
    <script src="{% static 'home/js/diagrams.js' %}"></script> 
    <script type="text/javascript" charset="utf-8">

    function upload() {
      event.preventDefault();
      var data = new FormData($('#file-upload-form').get(0));
      console.log(data);
      $.ajax({
          url: $(this).attr('action'),
          type: $(this).attr('method'),
          data: data,
          cache: false,
          processData: false,
          contentType: false,
          success: function(data) {
              console.log(data);
              modifications = new Array;
              resetModifications();
              $.each(data, function(i,mod){
                console.log(mod);

                range_match = mod[2].match(/([\d]+)-([\d]+)/);
                console.log(range_match);
                range = new Array;
                if (range_match) {
                  // for (var i = range_match[1]; 1 > 0 ? i <= range_match[2] : i > range_match[2]; i += 1) {
                  //     range.push(i);
                  // }
                  start = parseInt(range_match[1]);
                  end = parseInt(range_match[2]);
                  for (var i = start; 1 > 0 ? i < end : i > end; i += 1) {
                      range.push(i);
                  }
                } else {
                  range.push(parseInt(mod[2]));
                }

                modi = {method: mod[1], type: mod[0], to: mod[5], from:mod[4], range: range, info: mod[3]};
                modifications.push(modi);
              });
              overlay_modifications();
              modifications_overview();
          }
      });
      return false;
    }

    $(function() {
        $('#file-upload-form').submit(upload);
    });

    $('#id_file_source').on("change", function(){ $('#file-upload-form').submit(); });

    var residues_pos = {{residues_pos|safe}};

    var default_sort = {
        "paging":   false,
        "ordering": true,
        "info":     false,
        "bFilter": true, 
        "bInfo": false,
        "order": [],
        // "fixedHeader": true,
        "scrollY": "600px",
        "autoWidth": false,
        "dom": 'lrtip'
    }

    var modifications = new Array;
    var tables = new Array;
    var mutations_browser = new Array;
    var removals_list = new Array;
    var export_list = {};
    var load_status = 0;
    var sequence = '';
    export_list['nterm'] = [];
    export_list['cterm'] = [];
    // export_list['icl3'] = [];
    export_list['icl3_start'] = [];
    export_list['icl3_end'] = [];
    export_list['icl2_start'] = [];
    export_list['icl2_end'] = [];
    export_list['thermo'] = [];
    export_list['removals'] = [];  

    var info_text = {};

    info_text['nterm'] = '<p class=info_text>Here you select the N-term truncation. The data comes from crystallized receptors and is grouped by the truncation\'s distance to TM1. It is possible to sort the data by occurrances (frequence) or by homology (Levels). Furthermore, it is possible to filter by fusion protein in N-term if it has interest.</p>';

    info_text['icl2_start'] = '<p class=info_text>Select the start position for the truncation within ICL2. The data comes from crystallized receptors and is grouped by their GPCRdb generic number. It is possible to sort the data by occurrances (frequence) or by homology (Levels). Furthermore, it is possible to filter by fusion protein in N-term if it has interest. Once the starting position is selected a new window will open to select the ending position.</p>';
    info_text['icl2_end'] = '<p class=info_text>Select the ending position for the ICL2 truncation.</p>';

    info_text['icl3_start'] = '<p class=info_text>Select the start position for the truncation within ICL3. The data comes from crystallized receptors and is grouped by their GPCRdb generic number. It is possible to sort the data by occurrances (frequence) or by homology (Levels). Furthermore, it is possible to filter by fusion protein in N-term if it has interest. Once the starting position is selected a new window will open to select the ending position.</p>';
    info_text['icl3_end'] = '<p class=info_text>Select the ending position for the ICL3 truncation.</p>';

    info_text['cterm'] = '<p class=info_text>Here you select the C-term truncation. The data comes from crystallized receptors and is grouped by the truncation\'s distance to TM8. It is possible to sort the data by occurrances (frequence) or by homology (Levels).</p>';
    info_text['termo'] = '<p class=info_text>Select mutation by click the mutation suggestion in the <i>Mutation</i> column.</p>';

    info_text['sites'] = '<p class=info_text>The tool recognizes possible site motifs. These can be attempted to be removed using the following mutations.</p>';
    info_text['custom'] = '<p class=info_text>Use options below to insert custom mutations or truncations not suggested by tool. You will be asked to confirm modification.</p>';
    info_text['current'] = '<p class=info_text>See current modifications below. These will be included if you export to excel.</p>';



    tables["custom"] = [info_text['custom']]
    tables["custom"].push( "Mutate: <input type='text' id='custom_pos' placeholder='sequence position'> to <input type='text' id='custom_mut' placeholder='aminoacid (1-letter)'> <input type='text'  id='custom_reason' placeholder='Reason'><input type=button value=Add onclick='custom_mut()'><div id=confirm_cus_mut></div><br>");
    tables["custom"].push( "Deletion: <input type='text' id='custom_del_start' placeholder='from (sequence position)'> - <input type='text' id='custom_del_end' placeholder='to (sequence number)'> <input type='text'  id='custom_del_reason' placeholder='Reason'><input type=button value=Add onclick='custom_del()'><div id=confirm_cus_del></del><br>");
    tables["custom"] = tables["custom"].join( "" );  

    tables["help"] = ['See small movie with a sample usage of tool: <button onclick="$(\'#toolvideo\').click();" mp4="http://files.gpcrdb.org/video/constructtool1.mp4" type="button" class="videoLink btn btn-xs btn-default">' +
                        '<span class="glyphicon glyphicon-film"></span>' +
                        '</button>']  
  
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>State</strong></div><div class='col-sm-10'>Select either Inactive or Active to limit the dataset to be crystals with chosen state.</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Fusion site</strong></div><div class='col-sm-10'>Select if and where the fusion protein to be inserted. This is used to make suggestions for the intercelluar loop (ICL) truncation based on crystals with fusion protein in same region.</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Export</strong></div><div class='col-sm-10'>Export all suggestions to an excel sheet for local analysis.</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Upload</strong></div><div class='col-sm-10'>Upload a previous construct design to continue work.</div></div>");
    tables["help"].push( "<br><div class='row'><div class='col-sm-2'><strong>Deletions</strong></div><div class='col-sm-10'>Methods to help guide truncations in different regions</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Mutations</strong></div><div class='col-sm-10'>Suggestions for thermostabilising mutations and for site removals</div></div>");
    tables["help"].push( "<div class='row'><div class='col-sm-2'><strong>Other</strong></div><div class='col-sm-10'>Create Custom modifications and see current modifications. Export current modificaitons to excel.</div></div>");
    tables["help"] = tables["help"].join( "" );  

    function stopPropagation(evt) {
      if (evt.stopPropagation !== undefined) {
        evt.stopPropagation();
      } else {
        evt.cancelBubble = true;
      }
    }

    function updateLoadStatus() {

      $('#loadstatus').html("Please wait while data is loaded. "+Math.round(load_status*100/11)+"% done");
      if (load_status != 11) {
        $('#method_options').hide();
      } else {
        $('#method_options').show();
        $('#loadstatus').hide();
      }
    }

    function showModal(heading,content, datatable){
      $("#myModalLabel").html(heading);
      $("#ModalBody").html(content);
      $("#myModal").modal("show");
      build_tooltips();
      if (typeof(datatable)!=='undefined'){
        default_sort["order"] = [];
        var db_table = $(datatable).DataTable(default_sort);
        console.log("DATATABLE");
      }

        var title = $('#fusion_search').text();
        $('#fusion_search').html( '<input type="text" onclick="stopPropagation(event);" placeholder="Search '+title+'" />' );

        // Apply the filter
        $("#fusion_search input").on( 'keyup change', function () {
            db_table.column( $('#fusion_search').index()+':visible' )
                    .search( this.value )
                    .draw();
        } );
    }

    function resetAll() {
      modifications = new Array;
      resetModifications();
      modifications_overview();
    }

    function build_tooltips() {
      $('[data-toggle="tooltip"]').tooltip();
      $('.prio_info').tooltip('destroy');
      $('.prio_info').tooltip({
          container: 'body',
          template: '<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner large"></div></div>'
      });
      $('.methods_info').tooltip('destroy');
      $('.methods_info').tooltip({
          template: '<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner medium"></div></div>'
      });
    }

    function resetModifications() {

      $('#snakeplot').find("circle").each(function( index ){
            //console.log( index + ": " + $( this ).text() );
            aa =  $(this).next().text();
            //console.log( index + ": " + aa );
            $(this).css("fill", 'white');
            $(this).next().css("fill", 'black');
          });

    }

  function getSortedKeys(obj) {
      var keys = []; for(var key in obj) keys.push(key);
      return keys.sort(function(a,b){return obj[b]['hits']-obj[a]['hits']});
  }

  function getSortedKeysPrio(obj) {
      var keys = []; for(var key in obj) keys.push(key);
      return keys.sort(function(a,b){
          // return obj[b]['priority']-obj[a]['priority']

          if (obj[a]['priority'] > obj[b]['priority']) return 1;
          if (obj[a]['priority'] < obj[b]['priority']) return -1;

          if (obj[a]['hits'] < obj[b]['hits']) return 1;
          if (obj[a]['hits'] > obj[b]['hits']) return -1;
        }
        );
  }
  function exportCSVsuggestions(){

    postData = JSON.stringify(export_list);
    $.ajax({
      type:    "POST",
      url:     "/common/exportexcelsuggestions",
      data:    {"d":postData},
      success: function(data) {
            $("body").append("<iframe src='/common/exportexceldownload/" + data+ "/{{target.entry_name}}' style='display: none;' ></iframe>");
      },
      // vvv---- This is the new bit
      error:   function(jqXHR, textStatus, errorThrown) {
            alert("Error, status = " + textStatus + ", " +
                  "error thrown: " + errorThrown
            );
            console.log("Error, status = " + textStatus + ", " +
                  "error thrown: " + errorThrown);
      }
    });
  }

  function exportToExcel(){

    postData = JSON.stringify(modifications);
    $.ajax({
      type:    "POST",
      url:     "/common/exportexcelmodifications",
      data:    {"d":postData, "s":sequence},
      success: function(data) {
            $("body").append("<iframe src='/common/exportexceldownload/" + data+ "/{{target.entry_name}}' style='display: none;' ></iframe>");
      },
      // vvv---- This is the new bit
      error:   function(jqXHR, textStatus, errorThrown) {
            alert("Error, status = " + textStatus + ", " +
                  "error thrown: " + errorThrown
            );
            console.log("Error, status = " + textStatus + ", " +
                  "error thrown: " + errorThrown);
      }
    });
  }

  function getSortedKeys_advanced(obj) {

    var keys = []; for(var key in obj) keys.push(key);
    return keys.sort(function(a,b){
      if (obj[a]['levels_num'][0] < obj[b]['levels_num'][0]) return 1;
      if (obj[a]['levels_num'][0] > obj[b]['levels_num'][0]) return -1;

      if (obj[a]['levels_num'][1] < obj[b]['levels_num'][1]) return 1;
      if (obj[a]['levels_num'][1] > obj[b]['levels_num'][1]) return -1;

      if (obj[a]['levels_num'][2] < obj[b]['levels_num'][2]) return 1;
      if (obj[a]['levels_num'][2] > obj[b]['levels_num'][2]) return -1;

      if (obj[a]['levels_num'][3] < obj[b]['levels_num'][3]) return 1;
      if (obj[a]['levels_num'][3] > obj[b]['levels_num'][3]) return -1;
      return 0;
    });
  }

    function build_nterm_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_nterm = {};
      show_table = {};
      level_num = 0
      $.each(n_term_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[3]) {
              if (fusionpos==vals[4] || (fusionpos=='None' && vals[4]!='nterm') || (fusionpos!='nterm' && vals[4]=='None') || 1==1) { //include all data regardless of fusion
                // console.log(state +" "+fusionpos+" "+level+" "+protein+" "+pdb+" "+vals);
                // TABLE
                if(!show_table[vals[2]]) { show_table[vals[2]] = {'gn': vals[2], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table[vals[2]]['proteins'].indexOf(protein)==-1) {
                  show_table[vals[2]]['proteins'].push(protein);
                  show_table[vals[2]]['pdbs'].push(pdb);
                  show_table[vals[2]]['hits'] += 1;
                  show_table[vals[2]]['levels_num'][level_num] += 1;

                  if (vals[5] in show_table[vals[2]]['fusion_proteins_counts'] && vals[4]=='nterm' && vals[5]!=''){
                    show_table[vals[2]]['fusion_proteins_counts'][vals[5]] += 1;
                  } else if (vals[3]=='nterm' && vals[5]!='') {
                    show_table[vals[2]]['fusion_proteins_counts'][vals[5]] = 1;
                  }

                }

                if(show_table[vals[2]]['levels'].indexOf(level)==-1) {
                  show_table[vals[2]]['levels'].push(level);
                }

                if(show_table[vals[2]]['fusion_proteins'].indexOf(vals[5])==-1 && vals[4]=='nterm' && vals[5]!='') {
                  show_table[vals[2]]['fusion_proteins'].push(vals[5]);
                }

                if ( !(vals[5] in show_table[vals[2]]['fusion_proteins_counts']) && vals[4]=='nterm' && vals[5]!=''){
                    show_table[vals[2]]['fusion_proteins_counts'][vals[5]] = 1;
                }

              }
            }
          })
        })
        level_num += 1;
      }) 

      var items_table = [info_text['nterm'] + "<table id=nterm_sug class='table-striped table table-bordered'><thead><tr><th>From Helix 1</th><th>Freq</th><th>Levels</th><th id=fusion_search>Fusion proteins</th><th>Use</th></tr></thead><tbody>"];
      $.each( getSortedKeys_advanced(show_table), function( i, pos ) {
        val = show_table[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        temp = "<tr><td>"+pos+"</td><td>"+val['hits']+"</td><td data-order='"+i+"'>"+val['levels']+"</td><td>"+t_fusion+"</td><td><a href='#' onclick='nterm_tm1(this)' from='"+val['pdbs']+"' value='"+pos+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['nterm'].push([pos,val['hits'],val['levels'],val['fusion_proteins']])
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['nterm'] = result;
      $("#nterm_button").html("N-term ("+Object.keys(show_table).length+")");
      // $("#ModalBody").html(result);
    }

    function build_cterm_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_cterm = {};
      show_table = {};
      level_num = 0
      $.each(c_term_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[3]) {
                find = 1;
                // console.log(state +" "+fusionpos+" "+level+" "+protein+" "+pdb+" "+vals);
                if(!show_cterm[level]) { show_cterm[level] = {}; } 
                if(!show_cterm[level][vals[2]]) { show_cterm[level][vals[2]] = {'proteins': [],'pdbs': [], 'hits':0}; } 
                if(show_cterm[level][vals[2]]['proteins'].indexOf(protein)==-1) {
                  show_cterm[level][vals[2]]['proteins'].push(protein);
                  show_cterm[level][vals[2]]['pdbs'].push(pdb);
                  show_cterm[level][vals[2]]['hits'] += 1;
                }

                // TABLE
                if(!show_table[vals[2]]) { show_table[vals[2]] = {'gn': vals[2], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0}; }

                if(show_table[vals[2]]['proteins'].indexOf(protein)==-1) {
                  show_table[vals[2]]['proteins'].push(protein);
                  show_table[vals[2]]['pdbs'].push(pdb);
                  show_table[vals[2]]['hits'] += 1;
                  show_table[vals[2]]['levels_num'][level_num] += 1;
                }

                if(show_table[vals[2]]['levels'].indexOf(level)==-1) {
                  show_table[vals[2]]['levels'].push(level);
                }
            }
          })
        })
        if (find==1 ){
          show_cterm[level]['sortedkeys'] = getSortedKeys(show_cterm[level]);
        }
        level_num += 1;
      }) 

      var items_table = [info_text['cterm'] + "<table id=cterm_sug class='table-striped table table-bordered'><thead><tr><th>From Helix8 End</th><th>Freq</th><th>Levels</th><th>Use</th></tr></thead><tbody>"];
      $.each( getSortedKeys_advanced(show_table), function( i, pos ) {
        val = show_table[pos];
        temp = "<tr><td>"+(pos)+"</td><td>"+val['hits']+"</td><td data-order='"+i+"'>"+val['levels']+"</td><td><a href='#' onclick='cterm(this)' from='"+val['pdbs']+"' value='"+pos+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['cterm'].push([pos,val['hits'],val['levels']])
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['cterm'] = result;
      $("#cterm_button").html("C-term ("+Object.keys(show_table).length+")");

    }

    function build_icl3_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_icl3 = {};
      show_table = {};
      show_table_start = {};
      show_table_end = {};
      level_num = 0
      $.each(icl3_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[2]) {
              if (fusionpos==vals[3] || (fusionpos=='None' && vals[3]!='icl3') || (fusionpos!='icl3' && vals[3]=='None')) {
                find = 1;
                range = "5."+(50+vals[0])+"-"+"6."+(50-vals[1]);
                range_start = "5."+(50+vals[0]);
                range_end = "6."+(50-vals[1]);

                // TABLE
                if(!show_table_start[range_start]) { show_table_start[range_start] = {'start': vals[0], 'end': vals[1], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table_start[range_start]['proteins'].indexOf(protein)==-1) {
                  show_table_start[range_start]['proteins'].push(protein);
                  show_table_start[range_start]['pdbs'].push(pdb);
                  show_table_start[range_start]['hits'] += 1;
                  show_table_start[range_start]['levels_num'][level_num] += 1;

                  if (vals[4] in show_table_start[range_start]['fusion_proteins_counts'] && vals[3]=='icl3' && vals[4]!=''){
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] += 1;
                  } else if (vals[3]=='icl3' && vals[4]!='') {
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] = 1;
                  }

                }

                if(show_table_start[range_start]['levels'].indexOf(level)==-1) {
                  show_table_start[range_start]['levels'].push(level);
                }

                if(show_table_start[range_start]['fusion_proteins'].indexOf(vals[4])==-1 && vals[3]=='icl3' && vals[4]!='') {
                  show_table_start[range_start]['fusion_proteins'].push(vals[4]);
                }

                if ( !(vals[4] in show_table_start[range_start]['fusion_proteins_counts']) && vals[3]=='icl3' && vals[4]!=''){
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] = 1;
                }

                // TABLE
                if(!show_table_end[range_end]) { show_table_end[range_end] = {'start': vals[0], 'end': vals[1], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table_end[range_end]['proteins'].indexOf(protein)==-1) {
                  show_table_end[range_end]['proteins'].push(protein);
                  show_table_end[range_end]['pdbs'].push(pdb);
                  show_table_end[range_end]['hits'] += 1;
                  show_table_end[range_end]['levels_num'][level_num] += 1;

                  if (vals[4] in show_table_end[range_end]['fusion_proteins_counts'] && vals[3]=='icl3' && vals[4]!=''){
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] += 1;
                  } else if (vals[3]=='icl3' && vals[4]!='') {
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] = 1;
                  }

                }

                if(show_table_end[range_end]['levels'].indexOf(level)==-1) {
                  show_table_end[range_end]['levels'].push(level);
                }

                if(show_table_end[range_end]['fusion_proteins'].indexOf(vals[4])==-1 && vals[3]=='icl3' && vals[4]!='') {
                  show_table_end[range_end]['fusion_proteins'].push(vals[4]);
                }

                if ( !(vals[4] in show_table_end[range_end]['fusion_proteins_counts']) && vals[3]=='icl3' && vals[4]!=''){
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] = 1;
                }


              }
            }
          })
        })
        level_num += 1;
      }) 

      console.log(show_table_start);
      console.log(show_table_end);

      var items_table = [info_text['icl3_start'] + "<table id=icl3_sug_start class='table-striped table table-bordered'><thead><tr><th>Range</th><th>Freq</th><th>Levels</th><th id=fusion_search>Fusion</th><th>Use</th></tr></thead><tbody>"];
      $.each( getSortedKeys_advanced(show_table_start), function( i, pos ) {
        val = show_table_start[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        temp = "<tr><td>"+pos+"</td><td>"+val['hits']+"</td><td>"+val['levels']+"</td><td>"+t_fusion+"</td><td><a href='#' onclick='icl3_start(this)' from='"+val['pdbs']+"' tm5='"+val['start']+"'  tm6='"+val['end']+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['icl3_start'].push([pos,val['hits'],val['levels'],val['pdbs']]) //,val['start'],val['end']
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['icl3_start'] = result;
      {% if class == 'A' and residues.ICL3|length < 9 %}
      if (fusionpos!='icl3'){
        tables['icl3_start'] = "Loop is too short to require a truncation without a fusion protein";
      }
      {% endif %}
      var items_table = [info_text['icl3_end'] + "<div id=icl3_start_info></div><table id=icl3_sug_end class='table-striped table table-bordered'><thead><tr><th>Range</th><th>Freq</th><th>Levels</th><th id=fusion_search>Fusion</th><th>Use</th></tr></thead><tbody>"];
      $.each( getSortedKeys_advanced(show_table_end), function( i, pos ) {
        val = show_table_end[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        temp = "<tr><td>"+pos+"</td><td>"+val['hits']+"</td><td data-order='"+i+"'>"+val['levels']+"</td><td>"+t_fusion+"</td><td><a href='#' onclick='icl3(this)' from='"+val['pdbs']+"' tm5='"+val['start']+"'  tm6='"+val['end']+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['icl3_end'].push([pos,val['hits'],val['levels'],val['pdbs']]) //,val['start'],val['end']
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['icl3_end'] = result;
      

      $("#icl3_start_button").html("ICL3 ("+Object.keys(show_table_start).length+")");
    }

    function build_icl2_menu() {
      var state = $('input:radio[name=state]:checked').val();
      var fusionpos = $('input:radio[name=fusionpos]:checked').val();
      show_icl2 = {};
      show_table_start = {};
      show_table_end = {};
      level_num = 0
      $.each(icl2_data, function(level,proteins) {
        find = 0;
        $.each(proteins, function(protein, pdbs){
          $.each(pdbs, function(pdb, vals){
            // Do checks!
            if (state==vals[2]) {
              if (fusionpos==vals[3] || (fusionpos=='None' && vals[3]!='icl3') || (fusionpos!='icl3' && vals[3]=='None')) { //use icl3 cos thats how it is
                find = 1;
                range = "3."+(50+vals[0])+"-"+"4."+(50-vals[1]);

                range_start = "3."+(50+vals[0]);
                range_end = "4."+(50-vals[1]);

                // TABLE
                if(!show_table_start[range_start]) { show_table_start[range_start] = {'start': vals[0], 'end': vals[1], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table_start[range_start]['proteins'].indexOf(protein)==-1) {
                  show_table_start[range_start]['proteins'].push(protein);
                  show_table_start[range_start]['pdbs'].push(pdb);
                  show_table_start[range_start]['hits'] += 1;
                  show_table_start[range_start]['levels_num'][level_num] += 1;

                  if (vals[4] in show_table_start[range_start]['fusion_proteins_counts'] && vals[3]=='icl3' && vals[4]!=''){
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] += 1;
                  } else if (vals[3]=='icl3' && vals[4]!='') {
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] = 1;
                  }
                }

                if(show_table_start[range_start]['levels'].indexOf(level)==-1) {
                  show_table_start[range_start]['levels'].push(level);
                }

                if(show_table_start[range_start]['fusion_proteins'].indexOf(vals[4])==-1 && vals[3]=='icl3' && vals[4]!='') {
                  show_table_start[range_start]['fusion_proteins'].push(vals[4]);
                }

                if ( !(vals[4] in show_table_start[range_start]['fusion_proteins_counts']) && vals[3]=='icl3' && vals[4]!=''){
                    show_table_start[range_start]['fusion_proteins_counts'][vals[4]] = 1;
                }

                // TABLE
                if(!show_table_end[range_end]) { show_table_end[range_end] = {'start': vals[0], 'end': vals[1], 'levels':[], 'levels_num': [0,0,0,0], 'proteins': [],'pdbs': [], 'hits':0, 'fusion_proteins':[], 'fusion_proteins_counts':{}}; }

                if(show_table_end[range_end]['proteins'].indexOf(protein)==-1) {
                  show_table_end[range_end]['proteins'].push(protein);
                  show_table_end[range_end]['pdbs'].push(pdb);
                  show_table_end[range_end]['hits'] += 1;
                  show_table_end[range_end]['levels_num'][level_num] += 1;

                  if (vals[4] in show_table_end[range_end]['fusion_proteins_counts'] && vals[3]=='icl3' && vals[4]!=''){
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] += 1;
                  } else if (vals[3]=='icl3' && vals[4]!='') {
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] = 1;
                  }
                }

                if(show_table_end[range_end]['levels'].indexOf(level)==-1) {
                  show_table_end[range_end]['levels'].push(level);
                }
                if(show_table_end[range_end]['fusion_proteins'].indexOf(vals[4])==-1 && vals[3]=='icl3' && vals[4]!='') {
                  show_table_end[range_end]['fusion_proteins'].push(vals[4]);
                }

                if ( !(vals[4] in show_table_end[range_end]['fusion_proteins_counts']) && vals[3]=='icl3' && vals[4]!=''){
                    show_table_end[range_end]['fusion_proteins_counts'][vals[4]] = 1;
                }

              }
            }
          })
        })
        level_num += 1;
      }) 

      var items_table = [info_text['icl2_start'] + "<table id=icl2_sug_start class='table-striped table table-bordered'><thead><tr><th>Range</th><th>Freq</th><th>Levels</th><th>Fusion proteins</th><th>Use</th></tr></thead><tbody>"];
      $.each( getSortedKeys_advanced(show_table_start), function( i, pos ) {
        val = show_table_start[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        temp = "<tr><td>"+pos+"</td><td>"+val['hits']+"</td><td>"+val['levels']+"</td><td>"+t_fusion+"</td><td><a href='#' onclick='icl2_start(this)' from='"+val['pdbs']+"' tm3='"+val['start']+"'  tm4='"+val['end']+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['icl2_start'].push([pos,val['hits'],val['levels'],val['pdbs']]) //,val['start'],val['end']
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['icl2_start'] = result;
      var items_table = [info_text['icl2_end'] + "<div id=icl2_start_info></div><table  id=icl2_sug_end class='table-striped table table-bordered'><thead><tr><th>Range</th><th>Freq</th><th>Levels</th><th>Fusion proteins</th><th>Use</th></tr></thead><tbody>"];
      $.each( getSortedKeys_advanced(show_table_end), function( i, pos ) {
        val = show_table_end[pos];
        t_fusion = [];
        keysSorted = Object.keys(val['fusion_proteins_counts']).sort(function(a,b){return val['fusion_proteins_counts'][b]-val['fusion_proteins_counts'][a]});
        $.each(keysSorted, function(i,key) {
          t_fusion.push(key+'['+val['fusion_proteins_counts'][key]+']');
        })
        temp = "<tr><td>"+pos+"</td><td>"+val['hits']+"</td><td data-order='"+i+"'>"+val['levels']+"</td><td>"+t_fusion+"</td><td><a href='#' onclick='icl2(this)' from='"+val['pdbs']+"' tm3='"+val['start']+"'  tm4='"+val['end']+"' from=''>Apply</a></tr>";
        items_table.push( temp );
        export_list['icl2_end'].push([pos,val['hits'],val['levels'],val['pdbs']]) //,val['start'],val['end']
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['icl2_end'] = result;
      $("#icl2_start_button").html("ICL2 ("+Object.keys(show_table_start).length+")");
    }

    function build_mutations() {
      // console.log(mutations_browser);
      // console.log(mutations_browser.length);

      var state = $('input:radio[name=state]:checked').val();
      var keys = Object.keys(mutations_browser);
      export_list['thermo'] = [];
      muts = {}
      $.each(keys, function( i,type ) {
        if (type.substring(0, 11) == "struc_rules" && type.substring(12)!=state) {
          return true; //loop away from these
        }
        $.each(mutations_browser[type], function(gn, values){
          if(!muts[gn]) { muts[gn] = {'priority': 99, 'gn': gn, 'types': [], 'pretty_types': [], 'hits':0, 'details':[]}; }

          muts[gn]['hits'] += 1;

          muts[gn]['details'].push(values);
          if (type.substring(0, 11) == "struc_rules") {
            if (muts[gn]['priority']>5) muts[gn]['priority'] = 5;
            pretty_type = 'State-stabilising'
          } else if (type == "termo_From target recepter") {
            if (muts[gn]['priority']>1) muts[gn]['priority'] = 1;
            pretty_type = 'From Receptor'
          } else if (type == "termo_Common mutation (Wt)") {
            if (muts[gn]['priority']>2) muts[gn]['priority'] = 2;
            pretty_type = 'Observed (multiple)'
          } else if (type == "termo_Common mutation (Mut)") {
            if (muts[gn]['priority']>2) muts[gn]['priority'] = 2;
            pretty_type = 'Observed (multiple)'
          } else if (type == "termo_Single common mutation (Wt)") {
            if (muts[gn]['priority']>2) muts[gn]['priority'] = 3;
            pretty_type = 'Observed (single)'
          } else if (type == "cons_rm_conserved_G") {
            if (muts[gn]['priority']>4) muts[gn]['priority'] = 4;
            pretty_type = 'Conservation (remove Gly)'
          } else if (type == "cons_rm_nonconserved_GP") {
            if (muts[gn]['priority']>4) muts[gn]['priority'] = 2;
            pretty_type = 'Conservation (remove Gly/Pro)'
          } else if (type == "cons_rf_and_class") {
            if (muts[gn]['priority']>2) muts[gn]['priority'] = 2;
            pretty_type = 'Conservation'
          } else if (type == "cons_rf") {
            if (muts[gn]['priority']>2) muts[gn]['priority'] = 2;
            pretty_type = 'Conservation'
          } else if (type == "cons_strucs") {
            if (muts[gn]['priority']>2) muts[gn]['priority'] = 2;
            pretty_type = 'Conservation'
          } else {
            console.log(type);
          }

          muts[gn]['types'].push(type);
          muts[gn]['pretty_types'].push(pretty_type);
        });
      });
      // console.log(muts);

          prio_info = '<p class=info_text>Thermostabilising mutations have 5 priority levels based on method: <ol><li>From structure of this target ({{target.entry_name}})</li><li>Introducing conserved residue or observed in >2 structures</li><li>Observed in 1 structure</li><li>Increase helix propensity (Remove Gly)</li><li>State-stabilising interactions (e.g. ionic lock or sodium ion site)</li></ol></p>';

        var items_table = [info_text['termo']];
        items_table.push("<table id='mut_sug' class='table-striped table table-bordered'><thead><tr><th>Prio <a class='prio_info' data-toggle='tooltip' data-html='true' data-placement='bottom' title='"+prio_info+"'><i class='glyphicon glyphicon-info-sign'></i></a></th><th>Pos</th><th>Mut</th><th>Methods <a class='prio_info' data-toggle='tooltip' data-html='true' data-placement='bottom' title='"+prio_info+"'><i class='glyphicon glyphicon-info-sign'></i></a></th></tr></thead><tbody>");
        console.log(getSortedKeysPrio(muts));
      $.each( getSortedKeysPrio(muts), function( i, gn ) {
        vals = muts[gn];
        mut_suggestions = [];
        check = []
        label = []
        $.each(vals['details'], function(i, val) {
            // console.log(val);
            if (vals['types'][i].substring(0, 5) == "cons_") {
              label.push(val[0]+val[1]+val[2]);
              if ($.inArray(val[0]+val[1]+val[2], check)==-1) {
                mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' >"+val[0]+val[1]+val[2]+"</a>");
                check.push(val[0]+val[1]+val[2]);
              }
            } else if (vals['types'][i].substring(0, 5) == "termo") {
              $.each( val, function( key, value ) {
                if (vals['types'][i]=='termo_Common mutation (Wt)') {
                  // console.log(key);
                  // console.log(value);
                  $.each(value['muts'], function(ii, mut_aa) {
                    // console.log(mut_aa);
                    label.push(value['wt'][0]+value['wt'][1]+mut_aa);
                    if ($.inArray(value['wt'][0]+value['wt'][1]+mut_aa, check)==-1) {
                      mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+mut_aa+"'>"+value['wt'][0]+value['wt'][1]+mut_aa+"</a>");
                      check.push(value['wt'][0]+value['wt'][1]+mut_aa);
                    }
                   });
                } else if (vals['types'][i]=='termo_Single common mutation (Wt)') {
                  // console.log(key);
                  // console.log(value);
                  $.each(value['muts'], function(ii, mut_aa) {
                    // console.log(mut_aa);
                    label.push(value['wt'][0]+value['wt'][1]+mut_aa);
                    if ($.inArray(value['wt'][0]+value['wt'][1]+mut_aa, check)==-1) {
                      mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+mut_aa+"'>"+value['wt'][0]+value['wt'][1]+mut_aa+"</a>");
                      check.push(value['wt'][0]+value['wt'][1]+mut_aa);
                    }
                   });
                } else {
                    // temp += "<li><a onclick='mut(this)' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+to+"'><strong>Mutate "+value['wt'][0]+value['wt'][1]+to+"</strong></a></li>";

                  label.push(value['wt'][0]+value['wt'][1]+key);
                  if ($.inArray(value['wt'][0]+value['wt'][1]+key, check)==-1) {
                    mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+key+"'>"+value['wt'][0]+value['wt'][1]+key+"</a>");
                    check.push(value['wt'][0]+value['wt'][1]+key);
                  }
                }
              });

            } else if (vals['types'][i].substring(0, 11) == "struc_rules") {
              vals['types'][i] += ":"+val[0]['definition'];
              $.each( val, function( key, value ) {
                label.push(value['wt']+value['pos']+value['mut']);
                if ($.inArray(value['wt']+value['pos']+value['mut'], check)==-1) {
                  mut_suggestions.push("<a onclick='mut(this)'  data-animation='false' data-toggle='tooltip' title='"+vals['types'][i]+"' pos='"+value['pos']+"' gn='"+gn+"' wt='"+value['wt']+"' from='"+value['wt']+"' to='"+value['mut']+"' >"+value['wt']+value['pos']+value['mut']+"</a>");
                  check.push(value['wt']+value['pos']+value['mut']);
                }
              });
            }
        });
        //<td>"+vals['hits']+"</td>
        temp = "<tr><td align=center>"+vals['priority']+"</td><td>"+gn+"</td><td origin='"+vals['types']+"'>"+mut_suggestions.join(", ")+"</td><td>"+vals['pretty_types']+" <a class='methods_info' data-toggle='tooltip' data-html='true' data-placement='bottom' title='"+vals['types'].join("<br>")+"'><i class='glyphicon glyphicon-info-sign'></i></a></td></tr>";
        items_table.push( temp );
        export_list['thermo'].push([gn,label.join(", "),vals['hits'],vals['types']]);
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['mutations'] = result;
      $("#mutations_button").html("Thermostabilisation ("+Object.keys(muts).length+")");
    }

    function build_site_removals() {
      var keys = Object.keys(removals_list);
      removals = {}
      count = 0;
      var items_table = [info_text['sites'] + "<table  id='site_sug' class='table-striped table table-bordered'><thead><tr><th>Segment</th><th>Mutation</th><th>Type of removal</th></tr></thead><tbody>"];
      $.each(keys, function( i,type ) {
        $.each(removals_list[type], function(subtype, values){
          // console.log(type);
          // console.log(subtype);
          $.each(values, function(i, details) { 
            // console.log(i);
            // console.log(details);
            count += 1;
            if (details[2]!="") { //single mutation
              suggestion = "<a onclick='glyco(this)' motif='"+details[4]+"' pos='"+details[0]+"' wt='"+details[4][0]+"' from='"+details[4][0]+"' to='"+details[1]+"' to2='"+details[3]+"' wt2='"+details[4][1]+"'> Mutate "+details[4][0]+details[0]+details[1]+" & "+details[4][1]+parseInt(details[0]+1)+details[3]+"</a>";
              label = "Mutate "+details[4][0]+details[0]+details[1]+" & "+details[4][1]+parseInt(details[0]+1)+details[3];
            } else {
                suggestion =  "<a onclick='glyco(this)' motif='"+details[4]+"' pos='"+details[0]+"' wt='"+details[4][0]+"' from='"+details[4][0]+"' to='"+details[1]+"' > Mutate "+details[4][0]+details[0]+details[1]+"</a>";
                label = "Mutate "+details[4][0]+details[0]+details[1];
            }
            temp = "<tr><td>"+details[5]+"</td><td>"+suggestion+"</td><td>"+type+" ("+subtype+")</td></tr>";
            items_table.push( temp );
            export_list['removals'].push([details[5],label,type,subtype]);
          });
        });
      });
      items_table.push( "</tbody></table>" );
      result = items_table.join( "" );
      tables['site_removals'] = result;
      $("#removals_button").html("Site removals ("+count+")");
    }

    // ON CLICK FUNCTIONS

    function nterm_tm1(elem) {
      n_val = $(elem).attr("value");
      from = $(elem).attr("from").split(',');
      // until = {{residues_gn.1x50.sequence_number}}-n_val;

      until = {{residues.TM1.0.sequence_number}}-n_val;

      range = new Array;
      for (var i = 1; 1 > 0 ? i <= until : i > until; i += 1) {
          range.push(i);
      }

      $('#myModal').modal('hide');
      modi = {method: "n-term", type: "deletion", from: from, range: range, info: "Based on "+from.join(", ")};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
    }

    function cterm(elem) {
      n_val = $(elem).attr("value");
      from = $(elem).attr("from").split(',');
      // start = {{residues_gn.8x50.sequence_number}}-n_val;
      start = {{residues.Cterm.0.sequence_number}}+parseInt(n_val);
      {% with residues.Cterm|last as last %}
       end =   {{ last.sequence_number }};
      {% endwith %}

      range = new Array;
      for (var i = start; 1 > 0 ? i <= end : i > end; i += 1) {
          range.push(i);
      }

      $('#myModal').modal('hide');
      modi = {method: "c-term", type: "deletion", from: from, range: range, info: "Based on "+from.join(", ")};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
    }

    var icl3_del_start = 0;
    var icl_start_from = "";
    function icl3_start(elem) {
      icl3_del_start = $(elem).attr("tm5");
      icl_start_from = $(elem).attr("from");

      showModal("ICL3 (End)",tables["icl3_end"],"#icl3_sug_end");
      $("#icl3_start_info").html("Start selected: 3."+(50+parseInt(icl3_del_start)) );

    }

    function icl3(elem) {
      from = icl_start_from+","+$(elem).attr("from");
      from = Array.from(new Set(from.split(',')));
      end = {{residues_gn.6x50.sequence_number}}-$(elem).attr("tm6");
      start = {{residues_gn.5x50.sequence_number}}-(-icl3_del_start);
      // console.log(start+" "+end);

      range = new Array;
      for (var i = start; 1 > 0 ? i < end : i > end; i += 1) {
          range.push(i);
      }
      modi = {method: "ICL3", type: "deletion", from: from, range: range, info: "Based on "+from.join(", ")};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
      $('#myModal').modal('hide');
    }


    var icl2_del_start = 0;
    function icl2_start(elem) {
      icl2_del_start = $(elem).attr("tm3");
      icl_start_from = $(elem).attr("from");

      showModal("ICL2 (End)",tables["icl2_end"],"#icl2_sug_end");
      $("#icl2_start_info").html("Start selected: 3."+(50+parseInt(icl2_del_start)) );

    }

    function icl2(elem) {
      from = icl_start_from+$(elem).attr("from");
      from = Array.from(new Set(from.split(',')));

      end = {{residues_gn.4x50.sequence_number}}-$(elem).attr("tm4");
      start = {{residues_gn.3x50.sequence_number}}-(-icl3_del_start);
      // console.log(start+" "+end);

      range = new Array;
      for (var i = start; 1 > 0 ? i < end : i > end; i += 1) {
          range.push(i);
      }
      modi = {method: "ICL2", type: "deletion", from: from, range: range, info: "Based on "+from.join(", ")};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
      $('#myModal').modal('hide');
    }

    function custom_del(confirm) {
      start = $('#custom_del_start').val();
      end = $('#custom_del_end').val();
      reason = $('#custom_del_reason').val();

      start_gn = residues_pos[start][2];
      start_wt = residues_pos[start][0];
      start_seg = residues_pos[start][1];

      end_gn = residues_pos[end][2];
      end_wt = residues_pos[end][0];
      end_seg = residues_pos[end][1];

      label = start_wt+start+'-'+end_wt+end+' ('+start_seg+'/'+end_seg+')';
      if (typeof(confirm)==='undefined'){
        $('#confirm_cus_del').html('Custom deletion! '+label+' '+'Reason:'+reason+' <input type=button value=Confirm onclick=custom_del("1")>');
      } else {
        range = new Array;
        for (var i = parseInt(start); 1 > 0 ? i <= parseInt(end) : i > parseInt(end); i += 1) {
            range.push(i);
        }
        modi = {method: label, type: "deletion", to: to, range: range, info: "Custom deletion. Reason:"+reason};
        modifications.push(modi);
        overlay_modifications();
        modifications_overview();
        $('#confirm_cus_del').html('Added '+label);
        pos = $('#custom_del_end').val('');
        to = $('#custom_del_start').val('');
        reason = $('#custom_del_reason').val('');
      }
    }

    function custom_mut(confirm) {
      pos = $('#custom_pos').val();
      to = $('#custom_mut').val();
      reason = $('#custom_reason').val();
      gn = residues_pos[pos][2];
      wt = residues_pos[pos][0];
      seg = residues_pos[pos][1];


      label = wt+pos+to;
      if (typeof(confirm)==='undefined'){
        $('#confirm_cus_mut').html('Custom! '+label+' ('+seg+'/'+gn+') '+'Reason:'+reason+' <input type=button value=Confirm onclick=custom_mut("1")>');
      } else {
        range = new Array;
        range.push(pos);
        modi = {method: label+" "+gn, type: "mutation", to: to, range: range, info: "Custom mutation. Reason:"+reason};
        modifications.push(modi);
        overlay_modifications();
        modifications_overview();
        $('#confirm_cus_mut').html('Added '+label);
        pos = $('#custom_pos').val('');
        to = $('#custom_mut').val('');
        reason = $('#custom_reason').val('');
      }
    }

    function mut(elem) {
      gn = $(elem).attr("gn");
      pos = $(elem).attr("pos");
      to = $(elem).attr("to");
      wt = $(elem).attr("wt");

      origin = $(elem).parent().parent().parent().find('.origin').html();
      origin = $(elem).attr("title");
      origin = $(elem).parent().attr("origin");


      console.log(origin);

      range = new Array;
      range.push(pos);


      modi = {method: wt+pos+to+" "+gn, type: "mutation", to: to, range: range, info: "Based on: "+origin.split(',').join(', ')};
      modifications.push(modi);
      overlay_modifications();
      modifications_overview();
    }

    function glyco(elem) {
      pos = $(elem).attr("pos");
      to = $(elem).attr("to");
      wt = $(elem).attr("wt");
      to2 = $(elem).attr("to2");
      wt2 = $(elem).attr("wt2");

      origin = $(elem).attr("motif");

      // console.log(origin);

      range = new Array;
      range.push(pos);
      modi = {method: wt+pos+to + " Glycosylation", type: "mutation", to: to, range: range, info: "Based on "+origin};
      modifications.push(modi);

      if (to2) {
      range = new Array;
      pos2 = parseInt(parseInt(pos)+1)
      range.push(pos2);
      modi = {method: wt2+pos2+to2 + " Glycosylation", type: "mutation", to: to2, range: range, info: "Based on "+origin};
      modifications.push(modi);
      }

      overlay_modifications();
      modifications_overview();
    }

    function palmi(elem) {
      pos = $(elem).attr("pos");
      to = $(elem).attr("to");
      wt = $(elem).attr("wt");

      origin = $(elem).attr("motif");

      // console.log(origin);

      range = new Array;
      range.push(pos);
      modi = {method: wt+pos+to + " Palmitoylation site removal", type: "mutation", to: to, range: range, info: "Based on "+origin};
      modifications.push(modi);

      overlay_modifications();
      modifications_overview();
    }

    function modifications_overview() {

      // $("#overview").html("");
      tables["overview"] = [];
      tables["overview"].push(info_text['current'] + "<table class='table-striped table table-bordered'><tr><th>Type</th><th>Modification</th><th>Pos/Range</th><th>Based on</th><th>Extra</th></tr>");
      $.each(modifications, function(key,val) {

        type = val['type'];
        range = val['range'];
        method = val['method'];
        from = val['from'];

        if (val['info']) {
          info = "<p>"+val['info']+"</p>";
        } else {
          info = "";
        }

        if (val['range'].length == 1 ) {
          range = val['range'];
        } else {
          console.log(val['range']);
          // a = val['range'].split(',');
          range = val['range'][0]+" - "+val['range'][val['range'].length - 1];
        }


        row =  "<h3>"+method+" ("+type+")</h3>" +
            "<div>" +
            // "  <p>Based from "+from+"</p>" +
            // "  <p>"+range+"</p>" +
            info +
            "  <button onclick='remove_mod(this)' mod_id="+key+">Remove</button>" +
            "</div>"
        row =  "<tr><td>"+type+"</td><td>"+method+"</td><td>"+range+"</td><td>"+val['info']+"</td><td><button onclick='remove_mod(this)' mod_id="+key+">Remove</button></td></tr>";
        // $("#overview").append(row);
        tables["overview"].push(row);

      }) 
      tables["overview"].push("</table>");

      tables["overview"] = tables["overview"].join( "" );
      // $( "#overview" ).accordion( "refresh" );
      // $( "#overview" ).accordion({
      //   collapsible: true,
      //   active: false,
      // });

    }

    function remove_mod(elem) {
      id = $(elem).attr("mod_id");
      // console.log('remove id'+id)
      //delete modifications[id];
      modifications.splice(id, 1);
      resetModifications();
      overlay_modifications();
      modifications_overview();
      $("#ModalBody").html(tables["overview"]);

    }

    function overlay_modifications() {

      track_pos = {};
      $.each(modifications, function(key,val) {

        type = val['type'];
        range = val['range'];
        // console.log(val);

        $.each(range, function(i, ii){
          // console.log(ii,type);
          color_residue(ii,type);
          track_pos[ii] = val;
        })

      })
      // console.log(track_pos);
      sequence = "";
      $.each(residues_pos, function(key,val) {
        // console.log(key);
        // console.log(val);
        if (track_pos[key]){
          // console.log(track_pos[key]);
          if (track_pos[key]['type']=='mutation') {
            sequence += track_pos[key]['to'];
          console.log('added mutation'); 
          }
        } else {
          sequence += val[0];
          // console.log('added'); 
        }
      });
          console.log(sequence.length); 
          console.log(sequence); 
          export_list['sequence'] = [sequence];

    }

    function color_residue(pos, type) {

     if (type == 'deletion') {
        bg = 'red';
        fill = 'white';
     } else if (type == 'mutation') {
        bg = 'yellow';
        fill = 'red';
     }

     $('#'+pos+'t').css("fill", fill);
     $('#'+pos+'t').prev().css("fill", bg);


    }

  // Make snake plot big
  $(document).ready(function() {

    $('input[type=radio][name=state], input[type=radio][name=fusionpos]').change(function() {
          build_nterm_menu();
          build_cterm_menu();
          {% if class == 'A' or class == 'F' %}
              build_icl3_menu();
          {% elif class == 'B' or class == 'C' %}
              build_icl2_menu();
          {% endif %}
    });

    $( "#overview" ).accordion({
      collapsible: true,
      active: false,
    });

        $( "#dialog" ).dialog({
      autoOpen: false,
      show: {
        effect: "blind",
        duration: 200
      },
      hide: {
        effect: "explode",
        duration: 200
      },
      buttons: {
        "Reset": function() {
          $( this ).dialog( "close" );
          resetAll();
        },
        Cancel: function() {
          $( this ).dialog( "close" );
        }
      }
    });

        $(".long").show();
        $(".short").hide();
        maxmin();

      // http://localhost:8000/construct/tool/json/nterm/adrb2_human/
      $.getJSON( "/construct/tool/json/nterm/{{target.entry_name}}/", function( data ) {
          n_term_data = data; 
          build_nterm_menu();
          load_status += 1;
          updateLoadStatus();
        });

      // http://localhost:8000/construct/tool/json/cterm/adrb2_human/
      $.getJSON( "/construct/tool/json/cterm/{{target.entry_name}}/", function( data ) {
          c_term_data = data;
          build_cterm_menu();
          load_status += 1;
          updateLoadStatus();
        });

      console.log('icl3! {{residues.ICL3|length}}' );
      //and residues.ICL3|length > 8
    {% if class == 'A'  or class == 'F' %}
      // http://localhost:8000/construct/tool/json/icl3/adrb2_human/
      $.getJSON( "/construct/tool/json/icl3/{{target.entry_name}}/", function( data ) {
          icl3_data = data; 
          build_icl3_menu();
          load_status += 1;
          updateLoadStatus();
        });
    {% elif class == 'B' or class == 'C' %}
      // http://localhost:8000/construct/tool/json/icl3/adrb2_human/
      $.getJSON( "/construct/tool/json/icl2/{{target.entry_name}}/", function( data ) {
          icl2_data = data; 
          build_icl2_menu();
          load_status += 1;
          updateLoadStatus();
        });
    {% else %}
      icl3_data = [];
      load_status += 1;
    {% endif %}


      $.getJSON( "/construct/tool/json/glyco/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( type, val ) {
            temp = "<li id='" + type + "' class=\"dropdown-submenu\"><a>" + type + " ("+Object.keys(val).length+" hits)</a><ul class=\"dropdown-menu\">";
            $.each( val, function( key, value ) {
                if (type == 'mammalian') {
                temp += "<li id='"+key+"'  class=\"dropdown-submenu\"><a class='origin'>"+value[4][0]+value[0]+value[1]+" & "+value[4][1]+parseInt(value[0]+1)+value[3]+" ("+value[5]+")</a><ul  class=\"dropdown-menu\"><li><a onclick='glyco(this)' motif='"+value[4]+"' pos='"+value[0]+"' wt='"+value[4][0]+"' from='"+value[4][0]+"' to='"+value[1]+"' to2='"+value[3]+"' wt2='"+value[4][1]+"'> Mutate "+value[4][0]+value[0]+value[1]+" & "+value[4][1]+parseInt(value[0]+1)+value[3]+"</a></li></ul></li>";
                } else {
                temp += "<li id='"+key+"' class=\"dropdown-submenu\"><a class='origin'>"+value[4][0]+value[0]+value[1]+" ("+value[5]+")</a><ul class=\"dropdown-menu\"><li><a onclick='glyco(this)' motif='"+value[4]+"' pos='"+value[0]+"' wt='"+value[4][0]+"' from='"+value[4][0]+"' to='"+value[1]+"' > Mutate "+value[4][0]+value[0]+value[1]+"</a></li></ul></li>";
                }
            });

            temp += "</ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#glyco").html(result);
          removals_list["glyco"] = data;
          build_site_removals();
          load_status += 1;
          updateLoadStatus();
        });
                    
      // http://localhost:8000/construct/tool/json/palmi/adrb2_human/
      $.getJSON( "/construct/tool/json/palmi/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( type, val ) {
            temp = "";
            $.each( val, function( key, value ) {
                temp += "<li id='"+key+"' class=\"dropdown-submenu\"><a class='origin'>"+value[4][0]+value[0]+value[1]+" ("+value[5]+")</a><ul class=\"dropdown-menu\"><li><a onclick='palmi(this)' motif='"+value[4]+"' pos='"+value[0]+"' wt='"+value[4][0]+"' from='"+value[4][0]+"' to='"+value[1]+"' > Mutate "+value[4][0]+value[0]+value[1]+"</a></li></ul></li>";
            });

            temp += "</ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#palmi").html(result);
          removals_list["palmi"] = data;
          build_site_removals();
          load_status += 1;
          updateLoadStatus();
        });

        $.getJSON( "/construct/tool/json/cons_strucs/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( gn, val ) {
            temp = "<li id='"+gn+"' class=\"dropdown-submenu\"><a class='origin'>"+gn+" ("+val[0]+val[1]+val[2]+") ("+val[3]+"0% cons)</a><ul class=\"dropdown-menu\"><li><a onclick='mut(this)' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' > Mutate "+val[0]+val[1]+val[2]+"</a></li></ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#cons_strucs").html(result);
          mutations_browser['cons_strucs'] = data;
          build_mutations();
          load_status += 1;
          updateLoadStatus();
        });

        $.getJSON( "/construct/tool/json/cons_rf/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( gn, val ) {
            temp = "<li id='"+gn+"' class=\"dropdown-submenu\"><a class='origin'>"+gn+" ("+val[0]+val[1]+val[2]+") ("+val[3]+"0% cons)</a><ul class=\"dropdown-menu\"><li><a onclick='mut(this)' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' > Mutate "+val[0]+val[1]+val[2]+"</a></li></ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#cons_rf").html(result);
          mutations_browser['cons_rf'] = data;
          build_mutations();
          load_status += 1;
          updateLoadStatus();
        });

        $.getJSON( "/construct/tool/json/cons_rf_and_class/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( gn, val ) {
            temp = "<li id='"+gn+"' class=\"dropdown-submenu\"><a class='origin'>"+gn+" ("+val[0]+val[1]+val[2]+") ("+val[3]+"0% cons)</a><ul class=\"dropdown-menu\"><li><a onclick='mut(this)' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' > Mutate "+val[0]+val[1]+val[2]+"</a></li></ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#cons_rf_and_class").html(result);
          mutations_browser['cons_rf_and_class'] = data;
          build_mutations();
          load_status += 1;
          updateLoadStatus();
        });


        

        $.getJSON( "/construct/tool/json/cons_rm_GP/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( gn, val ) {
            temp = "<li id='"+gn+"' class=\"dropdown-submenu\"><a class='origin'>"+gn+" ("+val[0]+val[1]+val[2]+") ("+val[3]+"0% cons)</a><ul class=\"dropdown-menu\"><li><a onclick='mut(this)' cons='"+val[3]+"' pos='"+val[1]+"' gn='"+gn+"' wt='"+val[0]+"' from='"+val[0]+"' to='"+val[2]+"' > Mutate "+val[0]+val[1]+val[2]+"</a></li></ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#cons_rm_GP").html(result);
          mutations_browser['cons_rm_nonconserved_GP'] = data['non-conserved'];
          mutations_browser['cons_rm_conserved_G'] = data['conserved'];
          build_mutations();
          load_status += 1;
          updateLoadStatus();
        });

      $.getJSON( "/construct/tool/json/termo/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( level, gns ) {
            if (level == 1) {
              level_text = "From target recepter"
            } else if (level == 2) {
              level_text = "Common mutation (Mut)"
            } else if (level == 3) {
              level_text = "Common mutation (Wt)"
            } else if (level == 4) {
              level_text = "Single common mutation (Wt)"
            }
            mutations_browser['termo_'+level_text] = gns;
            temp = "<li id='" + level + "' class=\"dropdown-submenu\"><a>" + level_text + "</a><ul class=\"dropdown-menu\">";
            $.each( gns, function( gn, aa ) {
                $.each( aa, function( key, value ) {

                extra = " to ";
                to = key ; 
                number = value['pdbs'].length;
                if (level == 2) {
                  extra = " to ";
                  from = value['wt'][0];
                  to = key;
                  number = value['proteins'].length;
                } else if (level ==3 ){
                  extra = " to " + value['muts'] + " from ";
                  to = value['muts'];
                  number = value['proteins'].length;
                }

                temp += "<li id='" + level + "' class=\"dropdown-submenu\"><a>" + gn + extra + " ("+number+" hits)</a><ul class=\"dropdown-menu\">";
                temp += "<li><a>"+gn+" in {{target.entry_name}} is "+value['wt'][0]+"</a></li>";
                temp += "<li class=\"divider\"></li>";

                // pos = to.split(",");
                if (level == 3) {
                  $.each(to, function(key,pos){
                    temp += "<li><a onclick='mut(this)' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+pos+"'><strong>Mutate "+value['wt'][0]+value['wt'][1]+pos+"</strong></a></li>";
                  })
                } else {
                  temp += "<li><a onclick='mut(this)' pos='"+value['wt'][1]+"' gn='"+gn+"' wt='"+value['wt'][0]+"' from='"+value['wt'][0]+"' to='"+to+"'><strong>Mutate "+value['wt'][0]+value['wt'][1]+to+"</strong></a></li>";
                }
                temp += "<li class=\"divider\"></li>";
                if (level == 1 ) {
                  $.each(value['pdbs'], function(i, pdb) {
                      temp += "<li id='" + level + "'><a>" + pdb+"</a>";
                  })
                } else if (level == 2 || level == 3 ) {
                  $.each(value['proteins'], function(i, pdb) {
                      temp += "<li id='" + level + "'><a>" + pdb+"</a>";
                  })
                }
                // temp += "<li id='" + level + "' class=\"dropdown-submenu\"><a>" + key + " ("+value['hits']+" hits)</a>";
                // temp += "<ul class=\"dropdown-menu\"><li></li></ul>";

                temp += "</li>";
                temp += "</ul></li>";
                });
             });
            temp += "</ul></li>";
            items.push( temp );
          });
          result = items.join( "" );
          $("#thermo").html(result);
        });
          build_mutations();
          load_status += 1;
          updateLoadStatus();

    });

      $.getJSON( "/construct/tool/json/struc_rules/{{target.entry_name}}/", function( data ) {
          var items = [];
          $.each( data, function( level, gns ) {
            mutations_browser['struc_rules_'+level] = gns;
        });
          build_mutations();
          load_status += 1;
          updateLoadStatus();

    });
</script>
{% endblock %}

